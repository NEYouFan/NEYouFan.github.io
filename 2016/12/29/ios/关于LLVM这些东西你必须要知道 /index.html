
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>关于LLVM，这些东西你必须要知道 | 网易杭州前端技术部</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="网易杭州前端技术部">
    

    
    <meta name="description" content="&amp;#x53EA;&amp;#x8981;&amp;#x4F60;&amp;#x548C;&amp;#x4EE3;&amp;#x7801;&amp;#x6253;&amp;#x4EA4;&amp;#x9053;&amp;#xFF0C;&amp;#x4E86;&amp;#x89E3;&amp;#x7F16;&amp;#x8BD1;&amp;#x5668;&amp;#x7684;&amp;#x5DE5;&amp;#x4F5C;&amp;#x6D41;&amp;#x7A0B;&amp;#x548C;&amp;#x539F;&amp;#x7406;&amp;#x5B9A;&amp;#x4F1A;">
<meta property="og:type" content="article">
<meta property="og:title" content="关于LLVM，这些东西你必须要知道">
<meta property="og:url" content="http://NEYouFan.github.io/2016/12/29/ios/关于LLVM这些东西你必须要知道 /index.html">
<meta property="og:site_name" content="网易杭州前端技术部">
<meta property="og:description" content="&amp;#x53EA;&amp;#x8981;&amp;#x4F60;&amp;#x548C;&amp;#x4EE3;&amp;#x7801;&amp;#x6253;&amp;#x4EA4;&amp;#x9053;&amp;#xFF0C;&amp;#x4E86;&amp;#x89E3;&amp;#x7F16;&amp;#x8BD1;&amp;#x5668;&amp;#x7684;&amp;#x5DE5;&amp;#x4F5C;&amp;#x6D41;&amp;#x7A0B;&amp;#x548C;&amp;#x539F;&amp;#x7406;&amp;#x5B9A;&amp;#x4F1A;">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136450962.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136601642.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994028068.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994071651.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482150626825.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994093995.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218230417.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994171109.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218636504.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482219005958.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994195691.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994863704.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994879267.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320827975.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994222169.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482318703701.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320959711.png">
<meta property="og:updated_time" content="2017-01-05T06:15:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于LLVM，这些东西你必须要知道">
<meta name="twitter:description" content="&amp;#x53EA;&amp;#x8981;&amp;#x4F60;&amp;#x548C;&amp;#x4EE3;&amp;#x7801;&amp;#x6253;&amp;#x4EA4;&amp;#x9053;&amp;#xFF0C;&amp;#x4E86;&amp;#x89E3;&amp;#x7F16;&amp;#x8BD1;&amp;#x5668;&amp;#x7684;&amp;#x5DE5;&amp;#x4F5C;&amp;#x6D41;&amp;#x7A0B;&amp;#x548C;&amp;#x539F;&amp;#x7406;&amp;#x5B9A;&amp;#x4F1A;">
<meta name="twitter:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136450962.png">

    
    <link rel="alternative" href="/atom.xml" title="网易杭州前端技术部" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="网易杭州前端技术部">网易杭州前端技术部</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:NEYouFan.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/29/ios/关于LLVM这些东西你必须要知道 /" title="关于LLVM，这些东西你必须要知道" itemprop="url">关于LLVM，这些东西你必须要知道</a>
  </h1>
  <p class="article-author">By
       
		<span style="color: rgb(44, 166, 203);" >刘培庆</span>
		
  <p class="article-time">
    <time datetime="2016-12-28T16:00:00.000Z" itemprop="datePublished"> 发表于 2016-12-29</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-什么是LLVM？"><span class="toc-text">1. 什么是LLVM？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-安装编译LLVM"><span class="toc-text">2. 安装编译LLVM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-从源码到可执行文件"><span class="toc-text">3. 从源码到可执行文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-预处理（Preprocess）"><span class="toc-text">3.1 预处理（Preprocess）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-词法分析-Lexical-Analysis"><span class="toc-text">3.2 词法分析 (Lexical Analysis)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-语法分析-Semantic-Analysis"><span class="toc-text">3.3 语法分析 (Semantic Analysis)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-IR代码生成-CodeGen"><span class="toc-text">3.4 IR代码生成 (CodeGen)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-生成字节码-LLVM-Bitcode"><span class="toc-text">3.5 生成字节码 (LLVM Bitcode)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-生成相关汇编"><span class="toc-text">3.6 生成相关汇编</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-生成目标文件"><span class="toc-text">3.7 生成目标文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-生成可执行文件"><span class="toc-text">3.8 生成可执行文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-整体流程"><span class="toc-text">3.9 整体流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-可以用Clang做什么？"><span class="toc-text">4. 可以用Clang做什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-libclang进行语法分析"><span class="toc-text">4.1 libclang进行语法分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-LibTooling"><span class="toc-text">4.2 LibTooling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-ClangPlugin"><span class="toc-text">4.3 ClangPlugin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-动手写Pass"><span class="toc-text">5. 动手写Pass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-一个简单的Pass"><span class="toc-text">5.1 一个简单的Pass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-将Pass加入PassManager管理"><span class="toc-text">5.2 将Pass加入PassManager管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-总结"><span class="toc-text">6. 总结</span></a></li></ol>
		
		</div>
		
		<p>&#x53EA;&#x8981;&#x4F60;&#x548C;&#x4EE3;&#x7801;&#x6253;&#x4EA4;&#x9053;&#xFF0C;&#x4E86;&#x89E3;&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x5DE5;&#x4F5C;&#x6D41;&#x7A0B;&#x548C;&#x539F;&#x7406;&#x5B9A;&#x4F1A;&#x8BA9;&#x4F60;&#x53D7;&#x76CA;&#x65E0;&#x7A77;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;&#x5206;&#x6790;&#x7A0B;&#x5E8F;&#xFF0C;&#x8FD8;&#x662F;&#x57FA;&#x4E8E;&#x5B83;&#x5199;&#x81EA;&#x5DF1;&#x7684;&#x63D2;&#x4EF6;&#xFF0C;&#x751A;&#x81F3;&#x5B66;&#x4E60;&#x4E00;&#x95E8;&#x5168;&#x65B0;&#x7684;&#x8BED;&#x97F3;&#x3002;&#x901A;&#x8FC7;&#x672C;&#x6587;&#xFF0C;&#x5C06;&#x5E26;&#x4F60;&#x4E86;&#x89E3;LLVM&#xFF0C;&#x5E76;&#x4F7F;&#x7528;LLVM&#x6765;&#x5B8C;&#x6210;&#x4E00;&#x4E9B;&#x6709;&#x610F;&#x601D;&#x7684;&#x4E8B;&#x60C5;&#x3002;<a id="more"></a></p>
<h2 id="1-&#x4EC0;&#x4E48;&#x662F;LLVM&#xFF1F;"><a href="#1-&#x4EC0;&#x4E48;&#x662F;LLVM&#xFF1F;" class="headerlink" title="1. &#x4EC0;&#x4E48;&#x662F;LLVM&#xFF1F;"></a>1. &#x4EC0;&#x4E48;&#x662F;LLVM&#xFF1F;</h2><blockquote>
<p>The LLVM Project is a collection of modular and reusable compiler and toolchain technologies.</p>
</blockquote>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;&#xFF0C;LLVM&#x9879;&#x76EE;&#x662F;&#x4E00;&#x7CFB;&#x5217;&#x5206;&#x6A21;&#x5757;&#x3001;&#x53EF;&#x91CD;&#x7528;&#x7684;&#x7F16;&#x8BD1;&#x5DE5;&#x5177;&#x94FE;&#x3002;&#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x4EE3;&#x7801;&#x7F16;&#x5199;&#x826F;&#x597D;&#x7684;&#x4E2D;&#x95F4;&#x8868;&#x793A;(IR)&#xFF0C;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x591A;&#x79CD;&#x8BED;&#x8A00;&#x7684;&#x540E;&#x7AEF;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x4E0E;&#x53D8;&#x6210;&#x8BED;&#x8A00;&#x65E0;&#x5173;&#x7684;&#x4F18;&#x5316;&#x548C;&#x9488;&#x5BF9;&#x591A;&#x79CD;cpu&#x7684;&#x4EE3;&#x7801;&#x751F;&#x6210;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x5148;&#x6765;&#x770B;&#x4E0B;LLVM&#x67B6;&#x6784;&#x7684;&#x4E3B;&#x8981;&#x7EC4;&#x6210;&#x90E8;&#x5206;&#xFF1A;</p>
<ul>
<li>&#x524D;&#x7AEF;&#xFF1A;&#x524D;&#x7AEF;&#x7528;&#x6765;&#x83B7;&#x53D6;&#x6E90;&#x4EE3;&#x7801;&#x7136;&#x540E;&#x5C06;&#x5B83;&#x8F6C;&#x53D8;&#x4E3A;&#x67D0;&#x79CD;&#x4E2D;&#x95F4;&#x8868;&#x793A;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4E0D;&#x540C;&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x6765;&#x4F5C;&#x4E3A;LLVM&#x7684;&#x524D;&#x7AEF;&#xFF0C;&#x5982;gcc&#xFF0C;clang&#x3002;</li>
<li>Pass(&#x901A;&#x5E38;&#x7FFB;&#x8BD1;&#x4E3A;&#x201C;&#x6D41;&#x7A0B;&#x201D;)&#xFF1A;Pass&#x7528;&#x6765;&#x5C06;&#x7A0B;&#x5E8F;&#x7684;&#x4E2D;&#x95F4;&#x8868;&#x793A;&#x4E4B;&#x95F4;&#x76F8;&#x4E92;&#x53D8;&#x6362;&#x3002;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Pass&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x4F18;&#x5316;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x901A;&#x5E38;&#x662F;&#x6211;&#x4EEC;&#x5173;&#x6CE8;&#x7684;&#x90E8;&#x5206;&#x3002;</li>
<li>&#x540E;&#x7AEF;&#xFF1A;&#x540E;&#x7AEF;&#x7528;&#x6765;&#x751F;&#x6210;&#x5B9E;&#x9645;&#x7684;&#x673A;&#x5668;&#x7801;&#x3002;</li>
</ul>
<p>&#x867D;&#x7136;&#x5982;&#x4ECA;&#x5927;&#x591A;&#x6570;&#x7F16;&#x8BD1;&#x5668;&#x90FD;&#x91C7;&#x7528;&#x7684;&#x662F;&#x8FD9;&#x79CD;&#x67B6;&#x6784;&#xFF0C;&#x4F46;&#x662F;LLVM&#x4E0D;&#x540C;&#x7684;&#x5C31;&#x662F;&#x5BF9;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x8BED;&#x8A00;&#x5B83;&#x90FD;&#x63D0;&#x4F9B;&#x4E86;&#x540C;&#x4E00;&#x79CD;&#x4E2D;&#x95F4;&#x8868;&#x793A;&#x3002;&#x4F20;&#x7EDF;&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x67B6;&#x6784;&#x5982;&#x4E0B;:</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136450962.png"></center>

<p>LLVM&#x7684;&#x67B6;&#x6784;&#x5982;&#x4E0B;&#xFF1A;</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136601642.png"></center>

<p>&#x5F53;&#x7F16;&#x8BD1;&#x5668;&#x9700;&#x8981;&#x652F;&#x6301;&#x591A;&#x79CD;&#x6E90;&#x4EE3;&#x7801;&#x548C;&#x76EE;&#x6807;&#x67B6;&#x6784;&#x65F6;&#xFF0C;&#x57FA;&#x4E8E;LLVM&#x7684;&#x67B6;&#x6784;&#xFF0C;&#x8BBE;&#x8BA1;&#x4E00;&#x95E8;&#x65B0;&#x7684;&#x8BED;&#x8A00;&#x53EA;&#x9700;&#x8981;&#x53BB;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x524D;&#x7AEF;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x652F;&#x6301;&#x65B0;&#x7684;&#x540E;&#x7AEF;&#x67B6;&#x6784;&#x4E5F;&#x53EA;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x540E;&#x7AEF;&#x5C31;&#x884C;&#x4E86;&#x3002;&#x5176;&#x5B83;&#x90E8;&#x5206;&#x5B8C;&#x6210;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;&#x5C31;&#x4E0D;&#x7528;&#x518D;&#x91CD;&#x65B0;&#x8BBE;&#x8BA1;&#x4E00;&#x6B21;&#x4E86;&#x3002;</p>
<h2 id="2-&#x5B89;&#x88C5;&#x7F16;&#x8BD1;LLVM"><a href="#2-&#x5B89;&#x88C5;&#x7F16;&#x8BD1;LLVM" class="headerlink" title="2. &#x5B89;&#x88C5;&#x7F16;&#x8BD1;LLVM"></a>2. &#x5B89;&#x88C5;&#x7F16;&#x8BD1;LLVM</h2><p>&#x8FD9;&#x91CC;&#x4F7F;&#x7528;clang&#x4F5C;&#x4E3A;&#x524D;&#x7AEF;:</p>
<ol>
<li><p>&#x76F4;&#x63A5;&#x4ECE;&#x5B98;&#x7F51;&#x4E0B;&#x8F7D;:<a href="http://releases.llvm.org/download.html" target="_blank" rel="external">http://releases.llvm.org/download.html
</a></p>
</li>
<li><p>svn&#x83B7;&#x53D6;</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">svn co http://llvm.org/svn/llvm-project/llvm/trunk llvm</div><div class="line">cd llvm/tools</div><div class="line">svn co http://llvm.org/svn/llvm-project/cfe/trunk clang</div><div class="line">cd ../projects</div><div class="line">svn co http://llvm.org/svn/llvm-project/compiler-rt/trunk compiler-rt</div><div class="line">cd ../tools/clang/tools</div><div class="line">svn co http://llvm.org/svn/llvm-project/clang-tools-extra/trunk extra</div></pre></td></tr></table></figure>
<ol>
<li>git&#x83B7;&#x53D6;</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">git clone http://llvm.org/git/llvm.git</div><div class="line">cd llvm/tools</div><div class="line">git clone http://llvm.org/git/clang.git</div><div class="line">cd ../projects</div><div class="line">git clone http://llvm.org/git/compiler-rt.git</div><div class="line">cd ../tools/clang/tools</div><div class="line">git clone http://llvm.org/git/clang-tools-extra.git</div></pre></td></tr></table></figure>
<p>&#x6700;&#x65B0;&#x7684;LLVM&#x53EA;&#x652F;&#x6301;cmake&#x6765;&#x7F16;&#x8BD1;&#x4E86;&#xFF0C;&#x9996;&#x5148;&#x5B89;&#x88C5;cmake&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install cmake</div></pre></td></tr></table></figure>
<p>&#x7F16;&#x8BD1;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir build</div><div class="line">cmake /path/to/llvm/source</div><div class="line">cmake --build .</div></pre></td></tr></table></figure>
<p>&#x7F16;&#x8BD1;&#x65F6;&#x95F4;&#x6BD4;&#x8F83;&#x957F;&#xFF0C;&#x800C;&#x4E14;&#x7F16;&#x8BD1;&#x7ED3;&#x679C;&#x4F1A;&#x751F;&#x6210;20G&#x5DE6;&#x53F3;&#x7684;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x7F16;&#x8BD1;&#x5B8C;&#x6210;&#x540E;&#xFF0C;&#x5C31;&#x80FD;&#x5728;<code>build/bin/</code>&#x76EE;&#x5F55;&#x4E0B;&#x9762;&#x627E;&#x5230;&#x751F;&#x6210;&#x7684;&#x5DE5;&#x5177;&#x4E86;&#x3002;</p>
<h2 id="3-&#x4ECE;&#x6E90;&#x7801;&#x5230;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;"><a href="#3-&#x4ECE;&#x6E90;&#x7801;&#x5230;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;" class="headerlink" title="3. &#x4ECE;&#x6E90;&#x7801;&#x5230;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;"></a>3. &#x4ECE;&#x6E90;&#x7801;&#x5230;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;</h2><p>&#x6211;&#x4EEC;&#x5728;&#x5F00;&#x53D1;&#x7684;&#x65F6;&#x5019;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x8981;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x6216;&#x5E94;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x70B9;&#x51FB;run&#x5C31;&#x5B8C;&#x4E8B;&#x4E86;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x70B9;&#x51FB;run&#x4E4B;&#x540E;&#x7F16;&#x8BD1;&#x5668;&#x80CC;&#x540E;&#x53C8;&#x505A;&#x4E86;&#x54EA;&#x4E9B;&#x4E8B;&#x60C5;&#x5462;&#xFF1F;</p>
<p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">#define TEN 10</div><div class="line"></div><div class="line">int main(){</div><div class="line">    @autoreleasepool {</div><div class="line">        int numberOne = TEN;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    }</div><div class="line">    return 0;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x4E0A;&#x9762;&#x8FD9;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x884C;&#x76F4;&#x63A5;&#x7F16;&#x8BD1;&#xFF0C;&#x7136;&#x540E;&#x94FE;&#x63A5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">xcrun -sdk iphoneos clang -arch armv7 -F Foundation -fobjc-arc -c main.m -o main.o</div><div class="line">xcrun -sdk iphoneos clang main.o -arch armv7 -fobjc-arc -framework Foundation -o main</div></pre></td></tr></table></figure>
<p>&#x62F7;&#x8D1D;&#x5230;&#x624B;&#x673A;&#x8FD0;&#x884C;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">monkeyde-iPhone:/tmp root# ./main</div><div class="line">2016-12-19 17:16:34.654 main[2164:213100] Hello, AloneMonkey, Age: 18</div></pre></td></tr></table></figure>
<p>&#x5927;&#x5BB6;&#x4E0D;&#x4F1A;&#x4EE5;&#x4E3A;&#x5C31;&#x8FD9;&#x6837;&#x5C31;&#x5B8C;&#x4E86;&#x5427;&#xFF0C;&#x5F53;&#x7136;&#x4E0D;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x7EE7;&#x7EED;&#x6DF1;&#x5165;&#x5256;&#x6790;&#x3002;</p>
<h3 id="3-1-&#x9884;&#x5904;&#x7406;&#xFF08;Preprocess&#xFF09;"><a href="#3-1-&#x9884;&#x5904;&#x7406;&#xFF08;Preprocess&#xFF09;" class="headerlink" title="3.1 &#x9884;&#x5904;&#x7406;&#xFF08;Preprocess&#xFF09;"></a>3.1 &#x9884;&#x5904;&#x7406;&#xFF08;Preprocess&#xFF09;</h3><p>&#x8FD9;&#x90E8;&#x5206;&#x5305;&#x62EC;macro&#x5B8F;&#x7684;&#x5C55;&#x5F00;&#xFF0C;import/include&#x5934;&#x6587;&#x4EF6;&#x7684;&#x5BFC;&#x5165;&#xFF0C;&#x4EE5;&#x53CA;#if&#x7B49;&#x5904;&#x7406;&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF0C;&#x6765;&#x544A;&#x8BC9;clang&#x53EA;&#x6267;&#x884C;&#x5230;&#x9884;&#x5904;&#x7406;&#x8FD9;&#x4E00;&#x6B65;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -E main.m</div></pre></td></tr></table></figure>
<p>&#x6267;&#x884C;&#x5B8C;&#x8FD9;&#x4E2A;&#x547D;&#x4EE4;&#x4E4B;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0;&#x5BFC;&#x5165;&#x4E86;&#x5F88;&#x591A;&#x7684;&#x5934;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">......</div><div class="line"># 1 &quot;/System/Library/Frameworks/Foundation.framework/Headers/FoundationLegacySwiftCompatibility.h&quot; 1 3</div><div class="line"># 185 &quot;/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h&quot; 2 3</div><div class="line"># 2 &quot;main.m&quot; 2</div><div class="line"></div><div class="line">int main(){</div><div class="line">    @autoreleasepool {</div><div class="line">        int numberOne = 10;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    }</div><div class="line">    return 0;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x9884;&#x5904;&#x7406;&#x5DF2;&#x7ECF;&#x628A;&#x5B8F;&#x66FF;&#x6362;&#x4E86;&#xFF0C;&#x5E76;&#x4E14;&#x5BFC;&#x5165;&#x4E86;&#x5934;&#x6587;&#x4EF6;&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x6837;&#x7684;&#x8BDD;&#x4F1A;&#x5F15;&#x5165;&#x5F88;&#x591A;&#x4E0D;&#x4F1A;&#x53BB;&#x6539;&#x53D8;&#x7684;&#x7CFB;&#x7EDF;&#x5E93;&#x6BD4;&#x5982;Foundation&#xFF0C;&#x6240;&#x4EE5;&#x6709;&#x4E86;pch&#x9884;&#x5904;&#x7406;&#x6587;&#x4EF6;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x91CC;&#x53BB;&#x5F15;&#x5165;&#x4E00;&#x4E9B;&#x901A;&#x7528;&#x7684;&#x5934;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x540E;&#x6765;Xcode&#x65B0;&#x5EFA;&#x7684;&#x9879;&#x76EE;&#x91CC;&#x9762;&#x53BB;&#x6389;&#x4E86;pch&#x6587;&#x4EF6;&#xFF0C;&#x5F15;&#x5165;&#x4E86;moduels&#x7684;&#x6982;&#x5FF5;&#xFF0C;&#x628A;&#x4E00;&#x4E9B;&#x901A;&#x7528;&#x7684;&#x5E93;&#x6253;&#x6210;modules&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x7136;&#x540E;&#x5BFC;&#x5165;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x52A0;&#x4E0A;-fmodules&#x53C2;&#x6570;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -E -fmodules main.m</div></pre></td></tr></table></figure>
<p>&#x8FD9;&#x6837;&#x7684;&#x8BDD;&#xFF0C;&#x53EA;&#x9700;&#x8981;@import&#x4E00;&#x4E0B;&#x5C31;&#x80FD;&#x5BFC;&#x5165;&#x5BF9;&#x5E94;&#x5E93;&#x7684;modules&#x6A21;&#x5757;&#x4E86;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@import Foundation; </div><div class="line">int main(){</div><div class="line">    @autoreleasepool {</div><div class="line">        int numberOne = 10;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    }</div><div class="line">    return 0;</div><div class="line">}</div></pre></td></tr></table></figure>
<h3 id="3-2-&#x8BCD;&#x6CD5;&#x5206;&#x6790;-Lexical-Analysis"><a href="#3-2-&#x8BCD;&#x6CD5;&#x5206;&#x6790;-Lexical-Analysis" class="headerlink" title="3.2 &#x8BCD;&#x6CD5;&#x5206;&#x6790; (Lexical Analysis)"></a>3.2 &#x8BCD;&#x6CD5;&#x5206;&#x6790; (Lexical Analysis)</h3><p>&#x5728;&#x9884;&#x5904;&#x7406;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x8981;&#x8FDB;&#x884C;&#x8BCD;&#x6CD5;&#x5206;&#x6790;&#x4E86;&#xFF0C;&#x5C06;&#x9884;&#x5904;&#x7406;&#x8FC7;&#x7684;&#x4EE3;&#x7801;&#x8F6C;&#x5316;&#x6210;&#x4E00;&#x4E2A;&#x4E2A;Token&#xFF0C;&#x6BD4;&#x5982;&#x5DE6;&#x62EC;&#x53F7;&#x3001;&#x53F3;&#x62EC;&#x53F7;&#x3001;&#x7B49;&#x4E8E;&#x3001;&#x5B57;&#x7B26;&#x4E32;&#x7B49;&#x7B49;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -fmodules -fsyntax-only -Xclang -dump-tokens main.m</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994028068.png" alt="image"></p>
<h3 id="3-3-&#x8BED;&#x6CD5;&#x5206;&#x6790;-Semantic-Analysis"><a href="#3-3-&#x8BED;&#x6CD5;&#x5206;&#x6790;-Semantic-Analysis" class="headerlink" title="3.3 &#x8BED;&#x6CD5;&#x5206;&#x6790; (Semantic Analysis)"></a>3.3 &#x8BED;&#x6CD5;&#x5206;&#x6790; (Semantic Analysis)</h3><p>&#x6839;&#x636E;&#x5F53;&#x524D;&#x8BED;&#x8A00;&#x7684;&#x8BED;&#x6CD5;&#xFF0C;&#x9A8C;&#x8BC1;&#x8BED;&#x6CD5;&#x662F;&#x5426;&#x6B63;&#x786E;&#xFF0C;&#x5E76;&#x5C06;&#x6240;&#x6709;&#x8282;&#x70B9;&#x7EC4;&#x5408;&#x6210;&#x62BD;&#x8C61;&#x8BED;&#x6CD5;&#x6811;(AST)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -fmodules -fsyntax-only -Xclang -ast-dump main.m</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994071651.png" alt="image"></p>
<p>&#x8BED;&#x6CD5;&#x6811;&#x76F4;&#x89C2;&#x56FE;:</p>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482150626825.png" alt="image"></p>
<h3 id="3-4-IR&#x4EE3;&#x7801;&#x751F;&#x6210;-CodeGen"><a href="#3-4-IR&#x4EE3;&#x7801;&#x751F;&#x6210;-CodeGen" class="headerlink" title="3.4 IR&#x4EE3;&#x7801;&#x751F;&#x6210; (CodeGen)"></a>3.4 IR&#x4EE3;&#x7801;&#x751F;&#x6210; (CodeGen)</h3><p>CodeGen&#x8D1F;&#x8D23;&#x5C06;&#x8BED;&#x6CD5;&#x6811;&#x4ECE;&#x9876;&#x81F3;&#x4E0B;&#x904D;&#x5386;&#xFF0C;&#x7FFB;&#x8BD1;&#x6210;LLVM IR&#xFF0C;LLVM IR&#x662F;Frontend&#x7684;&#x8F93;&#x51FA;&#xFF0C;&#x4E5F;&#x662F;LLVM Backerend&#x7684;&#x8F93;&#x5165;&#xFF0C;&#x6865;&#x63A5;&#x524D;&#x540E;&#x7AEF;&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x5728;&#x4E2D;&#x95F4;&#x4EE3;&#x7801;&#x5C42;&#x6B21;&#x53BB;&#x505A;&#x4E00;&#x4E9B;&#x4F18;&#x5316;&#x5DE5;&#x4F5C;&#xFF0C;&#x6211;&#x4EEC;&#x5728;Xcode&#x7684;&#x7F16;&#x8BD1;&#x8BBE;&#x7F6E;&#x91CC;&#x9762;&#x4E5F;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x4F18;&#x5316;&#x7EA7;&#x522B;<code>-O1</code>,<code>-O3</code>,<code>-Os</code>&#x3002; &#x8FD8;&#x53EF;&#x4EE5;&#x53BB;&#x5199;&#x4E00;&#x4E9B;&#x81EA;&#x5DF1;&#x7684;Pass&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x89E3;&#x91CA;&#x4E00;&#x4E0B;&#x4EC0;&#x4E48;&#x662F;Pass&#x3002;</p>
<p>Pass&#x5C31;&#x662F;LLVM&#x7CFB;&#x7EDF;&#x8F6C;&#x5316;&#x548C;&#x4F18;&#x5316;&#x7684;&#x5DE5;&#x4F5C;&#x7684;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x6BCF;&#x4E2A;&#x8282;&#x70B9;&#x505A;&#x4E00;&#x4E9B;&#x5DE5;&#x4F5C;&#xFF0C;&#x8FD9;&#x4E9B;&#x5DE5;&#x4F5C;&#x52A0;&#x8D77;&#x6765;&#x5C31;&#x6784;&#x6210;&#x4E86;LLVM&#x6574;&#x4E2A;&#x7CFB;&#x7EDF;&#x7684;&#x4F18;&#x5316;&#x548C;&#x8F6C;&#x5316;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -S -fobjc-arc -emit-llvm main.m -o main.ll</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994093995.png" alt="image"></p>
<h3 id="3-5-&#x751F;&#x6210;&#x5B57;&#x8282;&#x7801;-LLVM-Bitcode"><a href="#3-5-&#x751F;&#x6210;&#x5B57;&#x8282;&#x7801;-LLVM-Bitcode" class="headerlink" title="3.5 &#x751F;&#x6210;&#x5B57;&#x8282;&#x7801; (LLVM Bitcode)"></a>3.5 &#x751F;&#x6210;&#x5B57;&#x8282;&#x7801; (LLVM Bitcode)</h3><p>&#x6211;&#x4EEC;&#x5728;Xcode7&#x4E2D;&#x9ED8;&#x8BA4;&#x751F;&#x6210;bitcode&#x5C31;&#x662F;&#x8FD9;&#x79CD;&#x7684;&#x4E2D;&#x95F4;&#x5F62;&#x5F0F;&#x5B58;&#x5728;&#xFF0C; &#x5F00;&#x542F;&#x4E86;bitcode&#xFF0C;&#x90A3;&#x4E48;&#x82F9;&#x679C;&#x540E;&#x53F0;&#x62FF;&#x5230;&#x7684;&#x5C31;&#x662F;&#x8FD9;&#x79CD;&#x4E2D;&#x95F4;&#x4EE3;&#x7801;&#xFF0C;&#x82F9;&#x679C;&#x53EF;&#x4EE5;&#x5BF9;bitcode&#x505A;&#x4E00;&#x4E2A;&#x8FDB;&#x4E00;&#x6B65;&#x7684;&#x4F18;&#x5316;&#xFF0C;&#x5982;&#x679C;&#x6709;&#x65B0;&#x7684;&#x540E;&#x7AEF;&#x67B6;&#x6784;&#xFF0C;&#x4ECD;&#x7136;&#x53EF;&#x4EE5;&#x7528;&#x8FD9;&#x4EFD;bitcode&#x53BB;&#x751F;&#x6210;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -emit-llvm -c main.m -o main.bc</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218230417.png" alt="image"></p>
<h3 id="3-6-&#x751F;&#x6210;&#x76F8;&#x5173;&#x6C47;&#x7F16;"><a href="#3-6-&#x751F;&#x6210;&#x76F8;&#x5173;&#x6C47;&#x7F16;" class="headerlink" title="3.6 &#x751F;&#x6210;&#x76F8;&#x5173;&#x6C47;&#x7F16;"></a>3.6 &#x751F;&#x6210;&#x76F8;&#x5173;&#x6C47;&#x7F16;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -S -fobjc-arc main.m -o main.s</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994171109.png" alt="image"></p>
<h3 id="3-7-&#x751F;&#x6210;&#x76EE;&#x6807;&#x6587;&#x4EF6;"><a href="#3-7-&#x751F;&#x6210;&#x76EE;&#x6807;&#x6587;&#x4EF6;" class="headerlink" title="3.7 &#x751F;&#x6210;&#x76EE;&#x6807;&#x6587;&#x4EF6;"></a>3.7 &#x751F;&#x6210;&#x76EE;&#x6807;&#x6587;&#x4EF6;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -fmodules -c main.m -o main.o</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218636504.png" alt="image"></p>
<h3 id="3-8-&#x751F;&#x6210;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;"><a href="#3-8-&#x751F;&#x6210;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;" class="headerlink" title="3.8 &#x751F;&#x6210;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;"></a>3.8 &#x751F;&#x6210;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">clang main.o -o main</div><div class="line">./main</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2016-12-20 15:25:42.299 main[8941:327306] Hello, AloneMonkey, Age: 18</div></pre></td></tr></table></figure>
<h3 id="3-9-&#x6574;&#x4F53;&#x6D41;&#x7A0B;"><a href="#3-9-&#x6574;&#x4F53;&#x6D41;&#x7A0B;" class="headerlink" title="3.9 &#x6574;&#x4F53;&#x6D41;&#x7A0B;"></a>3.9 &#x6574;&#x4F53;&#x6D41;&#x7A0B;</h3><p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482219005958.png" alt="image"></p>
<h2 id="4-&#x53EF;&#x4EE5;&#x7528;Clang&#x505A;&#x4EC0;&#x4E48;&#xFF1F;"><a href="#4-&#x53EF;&#x4EE5;&#x7528;Clang&#x505A;&#x4EC0;&#x4E48;&#xFF1F;" class="headerlink" title="4. &#x53EF;&#x4EE5;&#x7528;Clang&#x505A;&#x4EC0;&#x4E48;&#xFF1F;"></a>4. &#x53EF;&#x4EE5;&#x7528;Clang&#x505A;&#x4EC0;&#x4E48;&#xFF1F;</h2><h3 id="4-1-libclang&#x8FDB;&#x884C;&#x8BED;&#x6CD5;&#x5206;&#x6790;"><a href="#4-1-libclang&#x8FDB;&#x884C;&#x8BED;&#x6CD5;&#x5206;&#x6790;" class="headerlink" title="4.1 libclang&#x8FDB;&#x884C;&#x8BED;&#x6CD5;&#x5206;&#x6790;"></a>4.1 libclang&#x8FDB;&#x884C;&#x8BED;&#x6CD5;&#x5206;&#x6790;</h3><p>&#x53EF;&#x4EE5;&#x4F7F;&#x7528;libclang&#x91CC;&#x9762;&#x63D0;&#x4F9B;&#x7684;&#x65B9;&#x6CD5;&#x5BF9;&#x6E90;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x8BED;&#x6CD5;&#x5206;&#x6790;&#xFF0C;&#x5206;&#x6790;&#x5B83;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#xFF0C;&#x904D;&#x5386;&#x8BED;&#x6CD5;&#x6811;&#x4E0A;&#x9762;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#x3002;&#x53EF;&#x4EE5;&#x7528;&#x4E8E;&#x68C0;&#x67E5;&#x62FC;&#x5199;&#x9519;&#x8BEF;&#xFF0C;&#x6216;&#x8005;&#x505A;&#x5B57;&#x7B26;&#x4E32;&#x52A0;&#x5BC6;&#x3002;</p>
<p>&#x6765;&#x770B;&#x4E00;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x4F7F;&#x7528;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">void *hand = dlopen(&quot;/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/libclang.dylib&quot;,RTLD_LAZY);</div><div class="line">        </div><div class="line">//&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;&#x6307;&#x9488;</div><div class="line">initlibfunclist(hand);</div><div class="line"></div><div class="line">CXIndex cxindex = myclang_createIndex(1, 1);</div><div class="line"></div><div class="line">const char *filename = &quot;/path/to/filename&quot;;</div><div class="line"></div><div class="line">int index = 0;</div><div class="line"></div><div class="line">const char ** new_command = malloc(10240);</div><div class="line"></div><div class="line">NSMutableString *mus = [NSMutableString stringWithString:@&quot;/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -x objective-c -arch armv7 -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk&quot;]; </div><div class="line"></div><div class="line">NSArray *arr = [mus componentsSeparatedByString:@&quot; &quot;];</div><div class="line"></div><div class="line">for (NSString *tmp in arr) {</div><div class="line">    new_command[index++] = [tmp UTF8String];</div><div class="line">}</div><div class="line"></div><div class="line">nameArr = [[NSMutableArray alloc] initWithCapacity:10];</div><div class="line"></div><div class="line">TU = myclang_parseTranslationUnit(cxindex, filename, new_command, index, NULL, 0, myclang_defaultEditingTranslationUnitOptions());</div><div class="line"></div><div class="line">CXCursor rootCursor = myclang_getTranslationUnitCursor(TU);</div><div class="line"></div><div class="line">myclang_visitChildren(rootCursor, printVisitor, NULL);</div><div class="line"></div><div class="line">myclang_disposeTranslationUnit(TU);</div><div class="line">myclang_disposeIndex(cxindex);</div><div class="line">free(new_command);</div><div class="line"></div><div class="line">dlclose(hand);</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5728;<code>printVisitor</code>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x91CC;&#x9762;&#x53BB;&#x904D;&#x5386;&#x8F93;&#x5165;&#x6587;&#x4EF6;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x4E86;&#x3002;</p>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994195691.png" alt="image"></p>
<p>&#x6211;&#x4EEC;&#x4E5F;&#x901A;&#x8FC7;&#x901A;&#x8FC7;python&#x53BB;&#x8C03;&#x7528;&#x7528;clang&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install clang</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994863704.png" alt="image"></p>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994879267.png" alt="image"></p>
<p>&#x90A3;&#x4E48;&#x57FA;&#x4E8E;&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x9488;&#x5BF9;&#x5B57;&#x7B26;&#x4E32;&#x505A;&#x52A0;&#x5BC6;&#xFF1A;</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320827975.png"></center>

<p>&#x4ECE;&#x5DE6;&#x4E0A;&#x89D2;&#x7684;&#x660E;&#x6587;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x5904;&#x7406;&#x6210;&#x53F3;&#x4E0B;&#x89D2;&#x7684;&#x4ECB;&#x4E2A;&#x6837;&#x5B50;~</p>
<h3 id="4-2-LibTooling"><a href="#4-2-LibTooling" class="headerlink" title="4.2 LibTooling"></a>4.2 LibTooling</h3><p>&#x5BF9;&#x8BED;&#x6CD5;&#x6811;&#x6709;&#x5B8C;&#x5168;&#x7684;&#x63A7;&#x5236;&#x6743;&#xFF0C;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x547D;&#x4EE4;&#x4F7F;&#x7528;&#xFF0C;&#x5982;&#xFF1A;<code>clang-format</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang-format main.m</div></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x5199;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x5DE5;&#x5177;&#x53BB;&#x904D;&#x5386;&#x3001;&#x8BBF;&#x95EE;&#x3001;&#x751A;&#x81F3;&#x4FEE;&#x6539;&#x8BED;&#x6CD5;&#x6811;&#x3002; &#x76EE;&#x5F55;:<code>llvm/tools/clang/tools</code></p>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482994222169.png" alt="image"></p>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x901A;&#x8FC7;&#x904D;&#x5386;&#x8BED;&#x6CD5;&#x6811;&#xFF0C;&#x53BB;&#x4FEE;&#x6539;&#x91CC;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#x540D;&#x548C;&#x8FD4;&#x56DE;&#x53D8;&#x91CF;&#x540D;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">before:</div><div class="line">void do_math(int *x) {</div><div class="line">    *x += 5;</div><div class="line">}</div><div class="line"></div><div class="line">int main(void) {</div><div class="line">    int result = -1, val = 4;</div><div class="line">    do_math(&amp;val);</div><div class="line">    return result;</div><div class="line">}</div><div class="line"></div><div class="line">after:</div><div class="line">** Rewrote function def: do_math</div><div class="line">** Rewrote function call</div><div class="line">** Rewrote ReturnStmt</div><div class="line"></div><div class="line">Found 2 functions.</div><div class="line"></div><div class="line">void add5(int *x) {</div><div class="line">    *x += 5;</div><div class="line">}</div><div class="line"></div><div class="line">int main(void) {</div><div class="line">    int result = -1, val = 4;</div><div class="line">    add5(&amp;val);</div><div class="line">    return val;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x90A3;&#x4E48;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x5230;<code>LibTooling</code>&#x5BF9;&#x4EE3;&#x7801;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x6709;&#x5B8C;&#x5168;&#x7684;&#x63A7;&#x5236;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;&#x5B83;&#x53BB;&#x68C0;&#x67E5;&#x547D;&#x540D;&#x7684;&#x89C4;&#x8303;&#xFF0C;&#x751A;&#x81F3;&#x505A;&#x4E00;&#x4E2A;&#x4EE3;&#x7801;&#x7684;&#x8F6C;&#x6362;&#xFF0C;&#x6BD4;&#x5982;&#x5B9E;&#x73B0;OC&#x8F6C;Swift&#x3002;</p>
<h3 id="4-3-ClangPlugin"><a href="#4-3-ClangPlugin" class="headerlink" title="4.3 ClangPlugin"></a>4.3 ClangPlugin</h3><p>&#x5BF9;&#x8BED;&#x6CD5;&#x6811;&#x6709;&#x5B8C;&#x5168;&#x7684;&#x63A7;&#x5236;&#x6743;&#xFF0C;&#x4F5C;&#x4E3A;&#x63D2;&#x4EF6;&#x6CE8;&#x5165;&#x5230;&#x7F16;&#x8BD1;&#x6D41;&#x7A0B;&#x4E2D;&#xFF0C;&#x53EF;&#x4EE5;&#x5F71;&#x54CD;build&#x548C;&#x51B3;&#x5B9A;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;&#x3002;&#x76EE;&#x5F55;:<code>llvm/tools/clang/examples</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">#include &quot;clang/Driver/Options.h&quot;</div><div class="line">#include &quot;clang/AST/AST.h&quot;</div><div class="line">#include &quot;clang/AST/ASTContext.h&quot;</div><div class="line">#include &quot;clang/AST/ASTConsumer.h&quot;</div><div class="line">#include &quot;clang/AST/RecursiveASTVisitor.h&quot;</div><div class="line">#include &quot;clang/Frontend/ASTConsumers.h&quot;</div><div class="line">#include &quot;clang/Frontend/FrontendActions.h&quot;</div><div class="line">#include &quot;clang/Frontend/CompilerInstance.h&quot;</div><div class="line">#include &quot;clang/Frontend/FrontendPluginRegistry.h&quot;</div><div class="line">#include &quot;clang/Rewrite/Core/Rewriter.h&quot;</div><div class="line"></div><div class="line">using namespace std;</div><div class="line">using namespace clang;</div><div class="line">using namespace llvm;</div><div class="line"></div><div class="line">Rewriter rewriter;</div><div class="line">int numFunctions = 0;</div><div class="line"></div><div class="line"></div><div class="line">class ExampleVisitor : public RecursiveASTVisitor&lt;ExampleVisitor&gt; {</div><div class="line">private:</div><div class="line">    ASTContext *astContext; // used for getting additional AST info</div><div class="line"></div><div class="line">public:</div><div class="line">    explicit ExampleVisitor(CompilerInstance *CI) </div><div class="line">      : astContext(&amp;(CI-&gt;getASTContext())) // initialize private members</div><div class="line">    {</div><div class="line">        rewriter.setSourceMgr(astContext-&gt;getSourceManager(), astContext-&gt;getLangOpts());</div><div class="line">    }</div><div class="line"></div><div class="line">    virtual bool VisitFunctionDecl(FunctionDecl *func) {</div><div class="line">        numFunctions++;</div><div class="line">        string funcName = func-&gt;getNameInfo().getName().getAsString();</div><div class="line">        if (funcName == &quot;do_math&quot;) {</div><div class="line">            rewriter.ReplaceText(func-&gt;getLocation(), funcName.length(), &quot;add5&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote function def: &quot; &lt;&lt; funcName &lt;&lt; &quot;\n&quot;;</div><div class="line">        }    </div><div class="line">        return true;</div><div class="line">    }</div><div class="line"></div><div class="line">    virtual bool VisitStmt(Stmt *st) {</div><div class="line">        if (ReturnStmt *ret = dyn_cast&lt;ReturnStmt&gt;(st)) {</div><div class="line">            rewriter.ReplaceText(ret-&gt;getRetValue()-&gt;getLocStart(), 6, &quot;val&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote ReturnStmt\n&quot;;</div><div class="line">        }        </div><div class="line">        if (CallExpr *call = dyn_cast&lt;CallExpr&gt;(st)) {</div><div class="line">            rewriter.ReplaceText(call-&gt;getLocStart(), 7, &quot;add5&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote function call\n&quot;;</div><div class="line">        }</div><div class="line">        return true;</div><div class="line">    }</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">class ExampleASTConsumer : public ASTConsumer {</div><div class="line">private:</div><div class="line">    ExampleVisitor *visitor; // doesn&apos;t have to be private</div><div class="line"></div><div class="line">public:</div><div class="line">    // override the constructor in order to pass CI</div><div class="line">    explicit ExampleASTConsumer(CompilerInstance *CI):</div><div class="line">        visitor(new ExampleVisitor(CI)) { } // initialize the visitor</div><div class="line"></div><div class="line">    // override this to call our ExampleVisitor on the entire source file</div><div class="line">    virtual void HandleTranslationUnit(ASTContext &amp;Context) {</div><div class="line">        /* we can use ASTContext to get the TranslationUnitDecl, which is</div><div class="line">             a single Decl that collectively represents the entire source file */</div><div class="line">        visitor-&gt;TraverseDecl(Context.getTranslationUnitDecl());</div><div class="line">    }</div><div class="line">};</div><div class="line"></div><div class="line">class PluginExampleAction : public PluginASTAction {</div><div class="line">protected:</div><div class="line">    // this gets called by Clang when it invokes our Plugin</div><div class="line">    // Note that unique pointer is used here.</div><div class="line">    std::unique_ptr&lt;ASTConsumer&gt; CreateASTConsumer(CompilerInstance &amp;CI, StringRef file) {</div><div class="line">        return llvm::make_unique&lt;ExampleASTConsumer&gt;(&amp;CI);</div><div class="line">    }</div><div class="line"></div><div class="line">    // implement this function if you want to parse custom cmd-line args</div><div class="line">    bool ParseArgs(const CompilerInstance &amp;CI, const vector&lt;string&gt; &amp;args) {</div><div class="line">        return true;</div><div class="line">    }</div><div class="line">};</div><div class="line"></div><div class="line"></div><div class="line">static FrontendPluginRegistry::Add&lt;PluginExampleAction&gt; X(&quot;-example-plugin&quot;, &quot;simple Plugin example&quot;);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">clang -Xclang -load -Xclang ../build/lib/PluginExample.dylib -Xclang -plugin -Xclang -example-plugin -c testPlugin.c</div><div class="line"></div><div class="line">** Rewrote function def: do_math</div><div class="line">** Rewrote function call</div><div class="line">** Rewrote ReturnStmt</div></pre></td></tr></table></figure>
<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x57FA;&#x4E8E;ClangPlugin&#x505A;&#x4E9B;&#x4EC0;&#x4E48;&#x4E8B;&#x60C5;&#x5462;&#xFF1F;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x5B9A;&#x4E49;&#x4E00;&#x4E9B;&#x7F16;&#x7801;&#x89C4;&#x8303;&#xFF0C;&#x6BD4;&#x5982;&#x4EE3;&#x7801;&#x98CE;&#x683C;&#x68C0;&#x67E5;&#xFF0C;&#x547D;&#x540D;&#x68C0;&#x67E5;&#x7B49;&#x7B49;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x6211;&#x5199;&#x7684;&#x5224;&#x65AD;&#x7C7B;&#x540D;&#x524D;&#x4E24;&#x4E2A;&#x5B57;&#x6BCD;&#x662F;&#x4E0D;&#x662F;&#x5927;&#x5199;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#x62A5;&#x9519;&#x3002;(&#x5F53;&#x7136;&#x8FD9;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#x800C;&#x5DF2;&#x3002;&#x3002;&#x3002;)</p>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482318703701.png" alt="image"></p>
<h2 id="5-&#x52A8;&#x624B;&#x5199;Pass"><a href="#5-&#x52A8;&#x624B;&#x5199;Pass" class="headerlink" title="5. &#x52A8;&#x624B;&#x5199;Pass"></a>5. &#x52A8;&#x624B;&#x5199;Pass</h2><h3 id="5-1-&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;Pass"><a href="#5-1-&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;Pass" class="headerlink" title="5.1 &#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;Pass"></a>5.1 &#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;Pass</h3><p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x8BF4;&#x5230;&#xFF0C;Pass&#x5C31;&#x662F;LLVM&#x7CFB;&#x7EDF;&#x8F6C;&#x5316;&#x548C;&#x4F18;&#x5316;&#x7684;&#x5DE5;&#x4F5C;&#x7684;&#x4E00;&#x4E2A;&#x8282;&#x70B9;&#xFF0C;&#x5F53;&#x7136;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5199;&#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x8282;&#x70B9;&#x53BB;&#x505A;&#x4E00;&#x4E9B;&#x81EA;&#x5DF1;&#x7684;&#x4F18;&#x5316;&#x5DE5;&#x4F5C;&#x6216;&#x8005;&#x5176;&#x5B83;&#x7684;&#x64CD;&#x4F5C;&#x3002;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x6765;&#x770B;&#x4E00;&#x4E0B;&#x4E00;&#x4E2A;&#x7B80;&#x5355;Pass&#x7684;&#x7F16;&#x5199;&#x6D41;&#x7A0B;&#xFF1A;</p>
<p>1.&#x521B;&#x5EFA;&#x5934;&#x6587;&#x4EF6;  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd llvm/include/llvm/Transforms/</div><div class="line">mkdir Obfuscation</div><div class="line">cd Obfuscation</div><div class="line">touch SimplePass.h</div></pre></td></tr></table></figure>
<p>&#x5199;&#x5165;&#x5185;&#x5BB9;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#include &quot;llvm/IR/Function.h&quot;</div><div class="line">#include &quot;llvm/Pass.h&quot;</div><div class="line">#include &quot;llvm/Support/raw_ostream.h&quot;</div><div class="line">#include &quot;llvm/IR/Intrinsics.h&quot;</div><div class="line">#include &quot;llvm/IR/Instructions.h&quot;</div><div class="line">#include &quot;llvm/IR/LegacyPassManager.h&quot;</div><div class="line">#include &quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</div><div class="line"></div><div class="line">// Namespace</div><div class="line">using namespace std;</div><div class="line"></div><div class="line">namespace llvm {</div><div class="line">	Pass *createSimplePass(bool flag);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>2.&#x521B;&#x5EFA;&#x6E90;&#x6587;&#x4EF6;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cd llvm/lib/Transforms/</div><div class="line">mkdir Obfuscation</div><div class="line">cd Obfuscation</div><div class="line"></div><div class="line">touch CMakeLists.txt</div><div class="line">touch LLVMBuild.txt</div><div class="line">touch SimplePass.cpp</div></pre></td></tr></table></figure>
<p>CMakeLists.txt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">add_llvm_loadable_module(LLVMObfuscation</div><div class="line">  SimplePass.cpp</div><div class="line">  </div><div class="line">  )</div><div class="line"></div><div class="line">  add_dependencies(LLVMObfuscation intrinsics_gen)</div></pre></td></tr></table></figure>
<p>LLVMBuild.txt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[component_0]</div><div class="line">type = Library</div><div class="line">name = Obfuscation</div><div class="line">parent = Transforms</div><div class="line">library_name = Obfuscation</div></pre></td></tr></table></figure>
<p>SimplePass.cpp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">#include &quot;llvm/Transforms/Obfuscation/SimplePass.h&quot;</div><div class="line"></div><div class="line">using namespace llvm;</div><div class="line"></div><div class="line">namespace {</div><div class="line">    struct SimplePass : public FunctionPass {</div><div class="line">        static char ID; // Pass identification, replacement for typeid</div><div class="line">        bool flag;</div><div class="line">         </div><div class="line">        SimplePass() : FunctionPass(ID) {}</div><div class="line">        SimplePass(bool flag) : FunctionPass(ID) {</div><div class="line">        	this-&gt;flag = flag;</div><div class="line">        }</div><div class="line">         </div><div class="line">        bool runOnFunction(Function &amp;F) override {</div><div class="line">        	if(this-&gt;flag){</div><div class="line">                Function *tmp = &amp;F;</div><div class="line">                // &#x904D;&#x5386;&#x51FD;&#x6570;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x57FA;&#x672C;&#x5757;</div><div class="line">                for (Function::iterator bb = tmp-&gt;begin(); bb != tmp-&gt;end(); ++bb) {</div><div class="line">                    // &#x904D;&#x5386;&#x57FA;&#x672C;&#x5757;&#x4E2D;&#x7684;&#x6BCF;&#x6761;&#x6307;&#x4EE4;</div><div class="line">                    for (BasicBlock::iterator inst = bb-&gt;begin(); inst != bb-&gt;end(); ++inst) {</div><div class="line">                        // &#x662F;&#x5426;&#x662F;add&#x6307;&#x4EE4;</div><div class="line">                        if (inst-&gt;isBinaryOp()) {</div><div class="line">                            if (inst-&gt;getOpcode() == Instruction::Add) {</div><div class="line">                                ob_add(cast&lt;BinaryOperator&gt;(inst));</div><div class="line">                            }</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">            return false;</div><div class="line">        }</div><div class="line">         </div><div class="line">        // a+b === a-(-b)</div><div class="line">        void ob_add(BinaryOperator *bo) {</div><div class="line">            BinaryOperator *op = NULL;</div><div class="line">             </div><div class="line">            if (bo-&gt;getOpcode() == Instruction::Add) {</div><div class="line">                // &#x751F;&#x6210; (&#xFF0D;b)</div><div class="line">                op = BinaryOperator::CreateNeg(bo-&gt;getOperand(1), &quot;&quot;, bo);</div><div class="line">                // &#x751F;&#x6210; a-(-b)</div><div class="line">                op = BinaryOperator::Create(Instruction::Sub, bo-&gt;getOperand(0), op, &quot;&quot;, bo);</div><div class="line">                 </div><div class="line">                op-&gt;setHasNoSignedWrap(bo-&gt;hasNoSignedWrap());</div><div class="line">                op-&gt;setHasNoUnsignedWrap(bo-&gt;hasNoUnsignedWrap());</div><div class="line">            }</div><div class="line">             </div><div class="line">            // &#x66FF;&#x6362;&#x6240;&#x6709;&#x51FA;&#x73B0;&#x8BE5;&#x6307;&#x4EE4;&#x7684;&#x5730;&#x65B9;</div><div class="line">            bo-&gt;replaceAllUsesWith(op);</div><div class="line">        }</div><div class="line">    };</div><div class="line">}</div><div class="line"> </div><div class="line">char SimplePass::ID = 0;</div><div class="line"> </div><div class="line">// &#x6CE8;&#x518C;pass &#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x663E;&#x793A;&#x4E3A;simplepass</div><div class="line">static RegisterPass&lt;SimplePass&gt; X(&quot;simplepass&quot;, &quot;this is a Simple Pass&quot;);</div><div class="line">Pass *llvm::createSimplePass() { return new SimplePass(); }</div></pre></td></tr></table></figure>
<p>&#x4FEE;&#x6539;<code>.../Transforms/LLVMBuild.txt</code>, &#x52A0;&#x4E0A;&#x521A;&#x521A;&#x5199;&#x7684;&#x6A21;&#x5757;<code>Obfuscation</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">subdirectories = Coroutines IPO InstCombine Instrumentation Scalar Utils Vectorize ObjCARC Obfuscation</div></pre></td></tr></table></figure>
<p>&#x4FEE;&#x6539;<code>.../Transforms/CMakeLists.txt</code>,  &#x52A0;&#x4E0A;&#x521A;&#x521A;&#x5199;&#x7684;&#x6A21;&#x5757;<code>Obfuscation</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add_subdirectory(Obfuscation)</div></pre></td></tr></table></figure>
<p>&#x7F16;&#x8BD1;&#x751F;&#x6210;&#xFF1A;<code>LLVMSimplePass.dylib</code></p>
<p>&#x56E0;&#x4E3A;Pass&#x662F;&#x4F5C;&#x7528;&#x4E8E;&#x4E2D;&#x95F4;&#x4EE3;&#x7801;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x9996;&#x5148;&#x8981;&#x751F;&#x6210;&#x4E00;&#x4EFD;&#x4E2D;&#x95F4;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -emit-llvm -c test.c -o test.bc</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x52A0;&#x8F7D;Pass&#x4F18;&#x5316;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">../build/bin/opt -load ../build/lib/LLVMSimplePass.dylib -test &lt; test.bc &gt; after_test.bc</div></pre></td></tr></table></figure>
<p>&#x5BF9;&#x6BD4;&#x4E2D;&#x95F4;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">llvm-dis test.bc -o test.ll</div><div class="line">llvm-dis after_test.bc -o after_test.ll</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">test.ll</div><div class="line">......</div><div class="line">entry:</div><div class="line">  %retval = alloca i32, align 4</div><div class="line">  %a = alloca i32, align 4</div><div class="line">  %b = alloca i32, align 4</div><div class="line">  %c = alloca i32, align 4</div><div class="line">  store i32 0, i32* %retval, align 4</div><div class="line">  store i32 3, i32* %a, align 4</div><div class="line">  store i32 4, i32* %b, align 4</div><div class="line">  %0 = load i32, i32* %a, align 4</div><div class="line">  %1 = load i32, i32* %b, align 4</div><div class="line">  %add = add nsw i32 %0, %1</div><div class="line">  store i32 %add, i32* %c, align 4</div><div class="line">  %2 = load i32, i32* %c, align 4</div><div class="line">  %call = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i32 %2)</div><div class="line">  ret i32 0</div><div class="line">}</div><div class="line">......</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">after_test.ll</div><div class="line">......</div><div class="line">entry:</div><div class="line">  %retval = alloca i32, align 4</div><div class="line">  %a = alloca i32, align 4</div><div class="line">  %b = alloca i32, align 4</div><div class="line">  %c = alloca i32, align 4</div><div class="line">  store i32 0, i32* %retval, align 4</div><div class="line">  store i32 3, i32* %a, align 4</div><div class="line">  store i32 4, i32* %b, align 4</div><div class="line">  %0 = load i32, i32* %a, align 4</div><div class="line">  %1 = load i32, i32* %b, align 4</div><div class="line">  %2 = sub i32 0, %1</div><div class="line">  %3 = sub nsw i32 %0, %2</div><div class="line">  %add = add nsw i32 %0, %1</div><div class="line">  store i32 %3, i32* %c, align 4</div><div class="line">  %4 = load i32, i32* %c, align 4</div><div class="line">  %call = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i32 %4)</div><div class="line">  ret i32 0</div><div class="line">}</div><div class="line">......</div></pre></td></tr></table></figure>
<p>&#x8FD9;&#x91CC;&#x5199;&#x7684;Pass&#x53EA;&#x662F;&#x628A;a+b&#x7B80;&#x5355;&#x7684;&#x66FF;&#x6362;&#x6210;&#x4E86;a-(-b),&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x6F14;&#x793A;&#xFF0C;&#x600E;&#x4E48;&#x53BB;&#x5199;&#x81EA;&#x5DF1;&#x7684;Pass&#xFF0C;&#x5E76;&#x4E14;&#x4F5C;&#x7528;&#x4E8E;&#x4EE3;&#x7801;&#x3002;</p>
<h3 id="5-2-&#x5C06;Pass&#x52A0;&#x5165;PassManager&#x7BA1;&#x7406;"><a href="#5-2-&#x5C06;Pass&#x52A0;&#x5165;PassManager&#x7BA1;&#x7406;" class="headerlink" title="5.2 &#x5C06;Pass&#x52A0;&#x5165;PassManager&#x7BA1;&#x7406;"></a>5.2 &#x5C06;Pass&#x52A0;&#x5165;PassManager&#x7BA1;&#x7406;</h3><p>&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x662F;&#x5355;&#x72EC;&#x53BB;&#x52A0;&#x8F7D;Pass&#x52A8;&#x6001;&#x5E93;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C06;Pass&#x52A0;&#x5165;PassManager&#xFF0C;&#x8FD9;&#x6837;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x901A;&#x8FC7;clang&#x7684;&#x53C2;&#x6570;&#x53BB;&#x52A0;&#x8F7D;&#x6211;&#x4EEC;&#x7684;Pass&#x4E86;&#x3002;</p>
<p>&#x9996;&#x5148;&#x5728;<code>llvm/lib/Transforms/IPO/PassManagerBuilder.cpp</code>&#x6DFB;&#x52A0;&#x5934;&#x6587;&#x4EF6;&#x3002;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#include &quot;llvm/Transforms/Obfuscation/SimplePass.h&quot;</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x8BED;&#x53E5;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">static cl::opt&lt;bool&gt; SimplePass(&quot;simplepass&quot;, cl::init(false),</div><div class="line">                           cl::desc(&quot;Enable simple pass&quot;));</div></pre></td></tr></table></figure>
<p>&#x7136;&#x540E;&#x5728;<code>populateModulePassManager</code>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x4E2D;&#x6DFB;&#x52A0;&#x5982;&#x4E0B;&#x4EE3;&#x7801;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MPM.add(createSimplePass(SimplePass));</div></pre></td></tr></table></figure>
<p>&#x6700;&#x540E;&#x5728;IPO&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#x7684;<code>LLVMBuild.txt</code>&#x4E2D;&#x6DFB;&#x52A0;&#x5E93;&#x7684;&#x652F;&#x6301;&#xFF0C;&#x5426;&#x5219;&#x5728;&#x7F16;&#x8BD1;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x63D0;&#x793A;&#x94FE;&#x63A5;&#x9519;&#x8BEF;&#x3002;&#x5177;&#x4F53;&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">required_libraries = Analysis Core InstCombine IRReader Linker Object ProfileData Scalar Support TransformUtils Vectorize Obfuscation</div></pre></td></tr></table></figure>
<p>&#x4FEE;&#x6539;Pass&#x7684;CMakeLists.txt&#x4E3A;&#x9759;&#x6001;&#x5E93;&#x5F62;&#x5F0F;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">add_llvm_library(LLVMObfuscation</div><div class="line">  SimplePass.cpp</div><div class="line">  )</div><div class="line"></div><div class="line">add_dependencies(LLVMObfuscation intrinsics_gen)</div></pre></td></tr></table></figure>
<p>&#x6700;&#x540E;&#x518D;&#x7F16;&#x8BD1;&#x4E00;&#x6B21;&#x3002;</p>
<p>&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x4E48;&#x53BB;&#x8C03;&#x7528;&#xFF1A;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">../build/bin/clang -mllvm -simplepass test.c -o after_test</div></pre></td></tr></table></figure>
<p>&#x57FA;&#x4E8E;Pass&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x505A;&#x4EC0;&#x4E48;&#xFF1F; &#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x7F16;&#x5199;&#x81EA;&#x5DF1;&#x7684;Pass&#x53BB;&#x6DF7;&#x6DC6;&#x4EE3;&#x7801;&#xFF0C;&#x4EE5;&#x589E;&#x52A0;&#x4ED6;&#x4EBA;&#x53CD;&#x7F16;&#x8BD1;&#x7684;&#x96BE;&#x5EA6;&#x3002;</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320959711.png"></center>

<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x628A;&#x4EE3;&#x7801;&#x5DE6;&#x4E0A;&#x89D2;&#x7684;&#x6837;&#x5B50;&#xFF0C;&#x53D8;&#x6210;&#x53F3;&#x4E0B;&#x89D2;&#x7684;&#x6837;&#x5B50;&#xFF0C;&#x751A;&#x81F3;&#x66F4;&#x52A0;&#x590D;&#x6742;~ </p>
<h2 id="6-&#x603B;&#x7ED3;"><a href="#6-&#x603B;&#x7ED3;" class="headerlink" title="6. &#x603B;&#x7ED3;"></a>6. &#x603B;&#x7ED3;</h2><p>&#x4E0A;&#x9762;&#x8BF4;&#x4E86;&#x90A3;&#x4E48;&#x8BF4;&#xFF0C;&#x6765;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#xFF1A;</p>
<p>1.LLVM&#x7F16;&#x8BD1;&#x4E00;&#x4E2A;&#x6E90;&#x6587;&#x4EF6;&#x7684;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<p>&#x9884;&#x5904;&#x7406; -&gt; &#x8BCD;&#x6CD5;&#x5206;&#x6790; -&gt; Token -&gt; &#x8BED;&#x6CD5;&#x5206;&#x6790; -&gt; AST -&gt; &#x4EE3;&#x7801;&#x751F;&#x6210; -&gt; LLVM IR -&gt; &#x4F18;&#x5316; -&gt; &#x751F;&#x6210;&#x6C47;&#x7F16;&#x4EE3;&#x7801; -&gt; Link -&gt; &#x76EE;&#x6807;&#x6587;&#x4EF6;</p>
<p>2.&#x57FA;&#x4E8E;LLVM&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x505A;&#x4EC0;&#x4E48;&#xFF1F;</p>
<ol>
<li>&#x505A;&#x8BED;&#x6CD5;&#x6811;&#x5206;&#x6790;&#xFF0C;&#x5B9E;&#x73B0;&#x8BED;&#x8A00;&#x8F6C;&#x6362;OC&#x8F6C;Swift&#x3001;JS or &#x5176;&#x5B83;&#x8BED;&#x8A00;&#xFF0C;&#x5B57;&#x7B26;&#x4E32;&#x52A0;&#x5BC6;&#x3002;</li>
<li>&#x7F16;&#x5199;ClangPlugin&#xFF0C;&#x547D;&#x540D;&#x89C4;&#x8303;&#xFF0C;&#x4EE3;&#x7801;&#x89C4;&#x8303;&#xFF0C;&#x6269;&#x5C55;&#x529F;&#x80FD;&#x3002;</li>
<li>&#x7F16;&#x5199;Pass&#xFF0C;&#x4EE3;&#x7801;&#x6DF7;&#x6DC6;&#x4F18;&#x5316;&#x3002;</li>
</ol>
<p>&#x8FD9;&#x7BC7;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x5165;&#x95E8;&#x4ECB;&#x7ECD;&#xFF0C;&#x4E2A;&#x4EBA;&#x8FD8;&#x9700;&#x8981;&#x6DF1;&#x5165;&#x53BB;&#x5B66;&#x4E60;LLVM&#xFF0C;&#x518D;&#x7ED9;&#x5927;&#x5BB6;&#x5206;&#x4EAB;&#xFF0C;&#x5982;&#x6709;&#x95EE;&#x9898;&#xFF0C;&#x6B22;&#x8FCE;&#x62CD;&#x7816;~  </p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/ios/">ios</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/LLVM/">LLVM</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://NEYouFan.github.io/2016/12/29/ios/关于LLVM这些东西你必须要知道 /" data-title="关于LLVM，这些东西你必须要知道 | 网易杭州前端技术部" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2016/12/23/android/Android Js引擎/Android平台上的JavaScript引擎/"  title="Android平台上的JavaScript引擎">
 <strong>下一篇：</strong><br/> 
 <span>Android平台上的JavaScript引擎
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2016/12/29/ios/关于LLVM这些东西你必须要知道 /" data-title="关于LLVM，这些东西你必须要知道" data-url="http://NEYouFan.github.io/2016/12/29/ios/关于LLVM这些东西你必须要知道 /"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-什么是LLVM？"><span class="toc-number">1.</span> <span class="toc-text">1. 什么是LLVM？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-安装编译LLVM"><span class="toc-number">2.</span> <span class="toc-text">2. 安装编译LLVM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-从源码到可执行文件"><span class="toc-number">3.</span> <span class="toc-text">3. 从源码到可执行文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-预处理（Preprocess）"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 预处理（Preprocess）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-词法分析-Lexical-Analysis"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 词法分析 (Lexical Analysis)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-语法分析-Semantic-Analysis"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 语法分析 (Semantic Analysis)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-IR代码生成-CodeGen"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 IR代码生成 (CodeGen)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-生成字节码-LLVM-Bitcode"><span class="toc-number">3.5.</span> <span class="toc-text">3.5 生成字节码 (LLVM Bitcode)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-生成相关汇编"><span class="toc-number">3.6.</span> <span class="toc-text">3.6 生成相关汇编</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-生成目标文件"><span class="toc-number">3.7.</span> <span class="toc-text">3.7 生成目标文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-生成可执行文件"><span class="toc-number">3.8.</span> <span class="toc-text">3.8 生成可执行文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9-整体流程"><span class="toc-number">3.9.</span> <span class="toc-text">3.9 整体流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-可以用Clang做什么？"><span class="toc-number">4.</span> <span class="toc-text">4. 可以用Clang做什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-libclang进行语法分析"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 libclang进行语法分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-LibTooling"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 LibTooling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-ClangPlugin"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 ClangPlugin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-动手写Pass"><span class="toc-number">5.</span> <span class="toc-text">5. 动手写Pass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-一个简单的Pass"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 一个简单的Pass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-将Pass加入PassManager管理"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 将Pass加入PassManager管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-总结"><span class="toc-number">6.</span> <span class="toc-text">6. 总结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/android/" title="android">android<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/ios/" title="ios">ios<sup>3</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/android工程模板/" title="android工程模板">android工程模板<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Jenkins/" title="Jenkins">Jenkins<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ci容器/" title="ci容器">ci容器<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/LLVM/" title="LLVM">LLVM<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Js引擎/" title="Js引擎">Js引擎<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/NeteaseAPM/" title="NeteaseAPM">NeteaseAPM<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/混合开发框架/" title="混合开发框架">混合开发框架<sup>1</sup></a></li>
			
		
		</ul>
</div>


  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">微信公众号</p>
  <div class="barcode">
    <img src="/img/qrcode_neyoufan.jpg" alt="">
  </div>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
               <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?78a4a5539516d8238b30820c93b43b1f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
		<p class="copyright">
		copyright © 2017
		
		<a href="/about" target="_blank" title="网易杭州前端技术部">网易杭州前端技术部</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"neyoufan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
